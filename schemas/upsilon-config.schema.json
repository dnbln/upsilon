{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/product.schema.json",
  "title": "Upsilon configuration",
  "description": "Upsilon configuration file format",
  "type": "object",
  "properties": {
    "vcs": {
      "description": "The VCS configuration",
      "type": "object",
      "properties": {
        "path": {
          "$ref": "#/definitions/non-empty-string",
          "description": "The path where to store the repositories"
        },
        "git-protocol": {
          "type": "object",
          "description": "The git protocol configuration",
          "properties": {
            "enable": {
              "type": "boolean",
              "description": "Enable the git protocol"
            },
            "git-daemon": {
              "type": "object",
              "description": "Git daemon configuration",
              "properties": {
                "start": {
                  "type": "boolean",
                  "description": "Start the git daemon"
                },
                "pidfile": {
                  "$ref": "#/definitions/non-empty-string",
                  "description": "The path to the git daemon pidfile"
                },
                "port": {
                  "type": "integer",
                  "description": "The port to use for the git protocol",
                  "default": 9418
                },
                "services": {
                  "type": "object",
                  "description": "Git daemon services configuration",
                  "properties": {
                    "upload-pack": {
                      "$ref": "#/definitions/git-daemon-service",
                      "description": "Configuration for the upload-pack service"
                    },
                    "upload-archive": {
                      "$ref": "#/definitions/git-daemon-service",
                      "description": "Configuration for the upload-archive service"
                    },
                    "receive-pack": {
                      "$ref": "#/definitions/git-daemon-service",
                      "description": "Configuration for the receive-pack service"
                    }
                  }
                }
              },
              "required": [
                "start"
              ],
              "additionalProperties": false
            }
          },
          "if": {
            "properties": {
              "enable": {
                "const": true
              }
            }
          },
          "then": {
            "required": [
              "git-daemon"
            ]
          },
          "required": [
            "enable"
          ],
          "additionalProperties": false
        }
      },
      "required": [
        "path",
        "git-protocol"
      ],
      "additionalProperties": false
    },
    "web": {
      "description": "Information about the server",
      "type": "object",
      "properties": {
        "api": {
          "description": "Information about the API backend",
          "type": "object",
          "properties": {
            "origin": {
              "$ref": "#/definitions/non-empty-string",
              "description": "The origin of the API backend"
            }
          },
          "required": [
            "origin"
          ],
          "additionalProperties": false
        },
        "web-interface": {
          "description": "Information about the web interface",
          "type": "object",
          "properties": {
            "origin": {
              "$ref": "#/definitions/non-empty-string",
              "description": "The origin of the web interface"
            }
          },
          "required": [
            "origin"
          ],
          "additionalProperties": false
        },
        "docs": {
          "description": "Information about the docs interface",
          "type": "object",
          "properties": {
            "origin": {
              "$ref": "#/definitions/non-empty-string",
              "description": "The origin of the docs interface"
            }
          },
          "required": [
            "origin"
          ],
          "additionalProperties": false
        }
      },
      "required": [
        "api"
      ],
      "additionalProperties": false
    },
    "data-backend": {
      "oneOf": [
        {
          "$ref": "#/definitions/postgres-data-backend"
        },
        {
          "$ref": "#/definitions/inmemory-data-backend"
        }
      ]
    },
    "users": {
      "description": "Configuration about users",
      "type": "object",
      "properties": {
        "register": {
          "description": "Configuration about user registration",
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean",
              "description": "Whether user registration is enabled"
            }
          },
          "required": [
            "enabled"
          ],
          "additionalProperties": false
        },
        "auth": {
          "description": "Configuration about user authentication",
          "type": "object",
          "properties": {
            "password": {
              "oneOf": [
                {
                  "$ref": "#/definitions/argon2-password-auth"
                },
                {
                  "$ref": "#/definitions/bcrypt-password-auth"
                }
              ]
            }
          },
          "required": [
            "password"
          ],
          "additionalProperties": false
        }
      },
      "required": [
        "auth",
        "register"
      ],
      "additionalProperties": false
    }
  },
  "required": [
    "vcs",
    "web",
    "data-backend",
    "users"
  ],
  "additionalProperties": false,
  "definitions": {
    "port": {
      "type": "integer",
      "minimum": 0,
      "exclusiveMaximum": 65536
    },
    "non-empty-string": {
      "type": "string",
      "minLength": 1
    },
    "postgres-data-backend": {
      "description": "Configuration for the data backend (Postgres)",
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "postgres"
        },
        "host": {
          "type": "string",
          "description": "The host where to reach the database"
        },
        "port": {
          "$ref": "#/definitions/port",
          "description": "Port the server listens on"
        },
        "user": {
          "$ref": "#/definitions/non-empty-string",
          "description": "The user that should be used to access the database"
        },
        "password": {
          "$ref": "#/definitions/non-empty-string",
          "description": "The password of the user that should be used to access the database"
        }
      },
      "required": [
        "type",
        "host",
        "port",
        "user",
        "password"
      ],
      "additionalProperties": false
    },
    "inmemory-data-backend": {
      "description": "Configuration for the data backend (In-memory)",
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "in-memory"
        },
        "save": {
          "type": "boolean",
          "description": "Whether to save the data in-memory to disk"
        },
        "path": {
          "$ref": "#/definitions/non-empty-string",
          "description": "The path where to store the data"
        }
      },
      "required": [
        "type",
        "save"
      ],
      "if": {
        "properties": {
          "save": {
            "const": true
          }
        }
      },
      "then": {
        "required": [
          "path"
        ]
      },
      "additionalProperties": false
    },
    "argon2-password-auth": {
      "description": "Configuration about password authentication (Argon2)",
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "argon2"
        },
        "passes": {
          "type": "integer",
          "description": "The number of passes to use for Argon2",
          "minimum": 2,
          "exclusiveMaximum": 12,
          "default": 6
        },
        "mem-cost": {
          "type": "integer",
          "description": "The memory cost to use for Argon2",
          "minimum": 1024,
          "default": 4096,
          "maximum": 65536
        }
      },
      "required": [
        "type"
      ],
      "additionalProperties": false
    },
    "bcrypt-password-auth": {
      "description": "Configuration about password authentication (BCrypt)",
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "bcrypt"
        },
        "cost": {
          "type": "integer",
          "description": "The cost of the BCrypt algorithm",
          "minimum": 4,
          "exclusiveMaximum": 32,
          "default": 11
        }
      },
      "required": [
        "type"
      ],
      "additionalProperties": false
    },
    "git-daemon-service": {
      "type": "object",
      "properties": {
        "enable": {
          "type": "boolean",
          "description": "Whether to enable"
        },
        "override": {
          "type": "string",
          "description": "Whether to allow/forbid individual repositories to override",
          "enum": [
            "default",
            "allow",
            "forbid"
          ]
        }
      },
      "required": [
        "enable"
      ],
      "if": {
        "properties": {
          "enable": {
            "const": true
          }
        }
      },
      "then": {
        "required": [
          "override"
        ]
      },
      "additionalProperties": false
    }
  }
}